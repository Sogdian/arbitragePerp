# Контекст проекта ArbitragePerp

## Описание проекта
Бот для анализа арбитража криптовалюты на фьючерсах между биржами (Bybit и Gate.io).

## История создания
Проект создан на основе логики из проекта `arbitrage`, но адаптирован для работы с фьючерсами и фандингами.

## Архитектура

### Основные компоненты:
1. **exchanges/** - Модуль для работы с биржами
   - `async_base_exchange.py` - Базовый класс для всех бирж
   - `async_bybit.py` - Клиент Bybit для фьючерсов
   - `async_gate.py` - Клиент Gate.io для фьючерсов
   - `async_mexc.py` - Клиент MEXC для фьючерсов
   - `async_lbank.py` - Клиент LBank для фьючерсов

2. **bot.py** - Основной бот, который:
   - Парсит вводные данные в формате: "монета Long (биржа), Short (биржа)"
   - Получает данные о ценах фьючерсов и фандингах с обеих бирж
   - Вычисляет спреды
   - Выводит информацию в лог

3. **input_parser.py** - Парсер вводных данных

4. **config.py** - Конфигурация (логирование)

## Формат ввода
```
монета Long (биржа), Short (биржа)
```
Пример: `CVC Long (bybit), Short (gate)`

## Формат вывода
Бот выводит:
- Цена монеты на фьючерс (монета) биржа: __
- Фандинг (монета) биржа: __
- Спред на цену на фьючерс (биржа1 и биржа2): __
- Спред на фандинги (биржа1 и биржа2): __

## API эндпоинты

**Важно:** Все используемые эндпоинты - публичные (market data), API ключи не требуются!

### Bybit:
- Тикер фьючерса: `/v5/market/tickers` (category=linear) - публичный
- Фандинг: `/v5/market/funding/history` (category=linear, limit=1) - публичный

### Gate.io:
- Тикер фьючерса: `/api/v4/futures/usdt/tickers` - публичный
- Фандинг: `/api/v4/futures/usdt/funding_rate` - публичный

### MEXC:
- Тикер фьючерса: `/api/v1/contract/ticker` - публичный
- Фандинг: `/api/v1/contract/funding_rate` - публичный

### LBank:
- Тикер фьючерса: `/v2/futures/ticker` - **может требовать API ключи**
- Фандинг: `/v2/futures/fundingRate` - **может требовать API ключи**
- **Примечание:** LBank может не предоставлять публичный API для фьючерсов. 
  Если запросы не работают, проверьте официальную документацию или используйте другие биржи.

## Следующие шаги (TODO)
Пользователь упомянул, что в следующем сообщении будут дополнительные вычисления, которые нужно реализовать.

## Зависимости
- httpx - для асинхронных HTTP запросов
- python-dotenv - для работы с .env файлами


## Логика работы бота

### Основная концепция
Бот определяет моменты времени для открытия и закрытия арбитражных позиций, используя два разных типа спредов:
- **Спред открытия позиции (max)** - для входа в арбитраж
- **Спред закрытия позиции (min)** - для выхода из арбитража

### Мониторинг спреда открытия позиции (max)

**Назначение:** Определить оптимальный момент для открытия Long и Short позиций на разных биржах.

**Что показывает:**
- Первое число - спред открытия между ask (биржа Long) и bid (биржа Short)
- Название монеты (для проверки)
- Ставка фандинга на бирже Long (long fr)
- Ставка фандинга на бирже Short (short fr)
- Разница между ставками фандинга (fr spread)

**Формула расчета спреда открытия:**
```
Спред открытия = (ask_long - bid_short) / bid_short * 100
```

**Когда открывать:**
- Когда спред открытия достигает максимального значения (заданного порога, например 9.5%)
- Общий спред (спред на цену + спред на фандинг) должен быть положительным и достаточным для покрытия комиссий

**Пример:**
- На разнице в ценах: +1.77%
- На разнице в ставках фандинга: -0.75%
- Итого общий спред: ~1.02%

### Мониторинг спреда закрытия позиции (min)

**Назначение:** Определить оптимальный момент для закрытия Long и Short позиций (обратные сделки).

**Что показывает:**
- Спред закрытия между bid (биржа Long) и ask (биржа Short)
- Это обратные цены относительно открытия позиции

**Формула расчета спреда закрытия:**
```
Спред закрытия = (bid_long - ask_short) / ask_short * 100
```

**Когда закрывать:**
- Когда спред закрытия достигает минимального значения (заданного порога, например -1%)
- Это момент, когда цены сходятся и можно фиксировать прибыль

### Ключевое различие между спредами

**Важно:** Спред открытия ≠ спред закрытия - это РАЗНЫЕ спреды!

**При открытии позиции:**
- Long: покупаем по **ask** на бирже A
- Short: продаем по **bid** на бирже B
- Спред = (ask_A - bid_B) / bid_B * 100

**При закрытии позиции:**
- Long: продаем по **bid** на бирже A
- Short: покупаем по **ask** на бирже B
- Спред = (bid_A - ask_B) / ask_B * 100

Это важно, потому что при открытии и закрытии используются разные стороны стакана (ask/bid), поэтому спреды различаются.

### Расчет спредов

1. **Спред на цену (pr_spread):**
   - Для открытия: (ask_long - bid_short) / bid_short * 100
   - Для закрытия: (bid_long - ask_short) / ask_short * 100

2. **Спред на фандинг (fr_spread):**
   - fr_long - fr_short (в процентах)
   - Показывает разницу в ставках фандинга между биржами

3. **Общий спред (total_spread):**
   - pr_spread + fr_spread
   - Учитывает как разницу в ценах, так и разницу в фандингах

### Настройки бота

- **Алерт спред min (%)**: Порог для закрытия позиции (например, -1%)
  - Когда спред закрытия достигает этого значения, приходит оповещение
- **Алерт спред max (%)**: Порог для открытия позиции (например, 9.5%)
  - Когда спред открытия достигает этого значения, приходит оповещение
- При достижении порогов - уведомления в Telegram и звуковые сигналы

### Работа бота

1. Бот каждую секунду запрашивает данные с бирж (цены ask/bid и фандинги)
2. Рассчитывает спреды открытия и закрытия
3. Выводит информацию в соответствующих окнах мониторинга
4. При достижении заданных порогов отправляет оповещения

### Пример работы

**Открытие позиции:**
- Найдена ситуация: GLM Long на MEXC, Short на Bybit
- Спред открытия достиг 9.5% → оповещение
- Открываем Long на MEXC (покупаем по ask) и Short на Bybit (продаем по bid) одновременно

**Закрытие позиции:**
- Мониторим спред закрытия
- Когда спред закрытия достигает -1% → оповещение
- Закрываем Long на MEXC (продаем по bid) и Short на Bybit (покупаем по ask) одновременно

