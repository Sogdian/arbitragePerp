# Контекст проекта ArbitragePerp

## Описание проекта
Бот для анализа арбитража криптовалюты на фьючерсах между биржами (Bybit и Gate.io).

## История создания
Проект создан на основе логики из проекта `arbitrage`, но адаптирован для работы с фьючерсами и фандингами.

## Архитектура

### Основные компоненты:
1. **exchanges/** - Модуль для работы с биржами
   - `async_base_exchange.py` - Базовый класс для всех бирж
   - `async_bybit.py` - Клиент Bybit для фьючерсов
   - `async_gate.py` - Клиент Gate.io для фьючерсов
   - `async_mexc.py` - Клиент MEXC для фьючерсов
   - `async_lbank.py` - Клиент LBank для фьючерсов

2. **bot.py** - Основной бот, который:
   - Парсит вводные данные в формате: "монета Long (биржа), Short (биржа)"
   - Получает данные о ценах фьючерсов и фандингах с обеих бирж
   - Вычисляет спреды
   - Выводит информацию в лог

3. **input_parser.py** - Парсер вводных данных

4. **config.py** - Конфигурация (логирование)

## Формат ввода
```
монета Long (биржа), Short (биржа)
```
Пример: `CVC Long (bybit), Short (gate)`

## Формат вывода
Бот выводит:
- Цена монеты на фьючерс (монета) биржа: __
- Фандинг (монета) биржа: __
- Спред на цену на фьючерс (биржа1 и биржа2): __
- Спред на фандинги (биржа1 и биржа2): __

## API эндпоинты

**Важно:** Все используемые эндпоинты - публичные (market data), API ключи не требуются!

### Bybit:
- **Базовый URL:** `https://api.bybit.com`
- **Тикер фьючерса:** `/v5/market/tickers` - публичный API
- **Фандинг:** `/v5/market/funding/history` - публичный API
- **Обязательные параметры:**
  - Тикер: `category=linear`, `symbol=COINUSDT`
  - Фандинг: `category=linear`, `symbol=COINUSDT`, `limit=1`
- **Формат символов:** `COINUSDT` (без подчеркивания, например, `CVCUSDT`, `BTCUSDT`)
- **Примечание:**
  - API полностью публичный, **API ключи не требуются**
  - Возвращает данные в формате `{"retCode": 0, "result": {...}}`
  - Если `retCode != 0`, монета недоступна или произошла ошибка
  - Тикер возвращает `lastPrice`, `bid1Price`, `ask1Price`
  - Фандинг возвращает историю, берется последний элемент (`fundingRate`)

### Gate.io:
- **Базовый URL:** `https://api.gateio.ws`
- **Тикер фьючерса:** `/api/v4/futures/usdt/tickers` - публичный API
- **Фандинг:** `/api/v4/futures/usdt/funding_rate` - публичный API
- **Обязательные параметры:**
  - Тикер: `contract=COIN_USDT`
  - Фандинг: `contract=COIN_USDT`
- **Формат символов:** `COIN_USDT` (с подчеркиванием, например, `CVC_USDT`, `BTC_USDT`)
- **Примечание:**
  - API полностью публичный, **API ключи не требуются**
  - Может возвращать данные как список или словарь
  - Тикер возвращает `last`, `bid`, `ask`
  - Фандинг возвращает `r` (funding rate) или `funding_rate`
  - Если данные не получены, монета недоступна или произошла ошибка

### MEXC:
- **Базовый URL:** `https://contract.mexc.com` (отдельный домен для фьючерсов)
- **Тикер фьючерса:** `/api/v1/contract/ticker` - публичный API
- **Фандинг:** `/api/v1/contract/funding_rate` - публичный API
- **Обязательные параметры:**
  - Тикер: `symbol=COIN_USDT`
  - Фандинг: `symbol=COIN_USDT`
- **Формат символов:** `COIN_USDT` (с подчеркиванием, например, `CVC_USDT`, `BTC_USDT`)
- **Примечание:**
  - API полностью публичный, **API ключи не требуются**
  - Может возвращать данные как список или словарь в поле `data`
  - Проверяется, что `code == 0` для успешного ответа
  - Проверяется, что `symbol` в ответе совпадает с запрошенным (для избежания ошибок)
  - Тикер возвращает `lastPrice`, `bid1`, `ask1`
  - Фандинг возвращает `fundingRate` (уже в десятичном формате, например, 0.000052 = 0.0052%)
  - Если данные не получены или символ не совпадает, монета недоступна или произошла ошибка

### LBank:
- **Базовый URL:** `https://lbkperp.lbank.com` (отдельный домен для фьючерсов)
- **Тикер фьючерса:** `/cfd/openApi/v1/pub/marketData` - публичный API
- **Фандинг:** `/cfd/openApi/v1/pub/marketData` - публичный API
- **Обязательный параметр:** `productGroup=SwapU` (должен передаваться во всех запросах)
- **Формат символов:** `COINUSDT` (без подчеркивания, например, `IOTAUSDT`, `BTCUSDT`)
- **Примечание:** 
  - LBank использует публичный API, **API ключи не требуются**
  - API может возвращать пустые массивы данных для некоторых монет
  - Если монета недоступна, API вернет `data: []`
  - Для надежности сначала запрашивается список всех доступных инструментов через `/cfd/openApi/v1/pub/instrument`
  - Если данные не получены, монета помечается как недоступная/делистированная

### XT.com:
- **Базовый URL:** `https://fapi.xt.com` (отдельный домен для фьючерсов)
- **Тикер фьючерса:** `/future/market/v1/public/q/ticker` - публичный API
- **Фандинг:** `/future/market/v1/public/q/funding-rate` - публичный API
- **Обязательные параметры:**
  - Тикер: `symbol=coin_usdt`
  - Фандинг: `symbol=coin_usdt`
- **Формат символов:** `coin_usdt` (нижний регистр, с подчеркиванием, например, `cvc_usdt`, `gps_usdt`, `btc_usdt`)
- **Примечание:**
  - API полностью публичный, **API ключи не требуются**
  - Возвращает данные в формате `{"returnCode": 0, "msgInfo": "success", "result": {...}}`
  - Если `returnCode != 0`, монета недоступна или произошла ошибка
  - Тикер возвращает `c` (last price), `b` (bid), `a` (ask) в поле `result`
  - Фандинг возвращает `fundingRate` в поле `result` (в десятичном формате, например, -0.02 = -2.0%)
  - **КРИТИЧНО:** Символы чувствительны к регистру - обязательно использовать нижний регистр
  - Если данные не получены, монета недоступна или произошла ошибка

## Следующие шаги (TODO)
Пользователь упомянул, что в следующем сообщении будут дополнительные вычисления, которые нужно реализовать.

## Зависимости
- httpx - для асинхронных HTTP запросов
- python-dotenv - для работы с .env файлами


## Логика работы бота

### Основная концепция
Бот определяет моменты времени для открытия и закрытия арбитражных позиций, используя два разных типа спредов:
- **Спред открытия позиции (max)** - для входа в арбитраж
- **Спред закрытия позиции (min)** - для выхода из арбитража

### Мониторинг спреда открытия позиции (max)

**Назначение:** Определить оптимальный момент для открытия Long и Short позиций на разных биржах.

**Что показывает:**
- Первое число - спред открытия между ask (биржа Long) и bid (биржа Short)
- Название монеты (для проверки)
- Ставка фандинга на бирже Long (long fr)
- Ставка фандинга на бирже Short (short fr)
- Разница между ставками фандинга (fr spread)

**Формула расчета спреда открытия:**
```
Спред открытия = (ask_long - bid_short) / bid_short * 100
```

**Когда открывать:**
- Когда спред открытия достигает максимального значения (заданного порога, например 9.5%)
- Общий спред (спред на цену + спред на фандинг) должен быть положительным и достаточным для покрытия комиссий

**Пример:**
- На разнице в ценах: +1.77%
- На разнице в ставках фандинга: -0.75%
- Итого общий спред: ~1.02%

### Мониторинг спреда закрытия позиции (min)

**Назначение:** Определить оптимальный момент для закрытия Long и Short позиций (обратные сделки).

**Что показывает:**
- Спред закрытия между bid (биржа Long) и ask (биржа Short)
- Это обратные цены относительно открытия позиции

**Формула расчета спреда закрытия:**
```
Спред закрытия = (bid_long - ask_short) / ask_short * 100
```

**Когда закрывать:**
- Когда спред закрытия достигает минимального значения (заданного порога, например -1%)
- Это момент, когда цены сходятся и можно фиксировать прибыль

### Ключевое различие между спредами

**Важно:** Спред открытия ≠ спред закрытия - это РАЗНЫЕ спреды!

**При открытии позиции:**
- Long: покупаем по **ask** на бирже A
- Short: продаем по **bid** на бирже B
- Спред = (ask_A - bid_B) / bid_B * 100

**При закрытии позиции:**
- Long: продаем по **bid** на бирже A
- Short: покупаем по **ask** на бирже B
- Спред = (bid_A - ask_B) / ask_B * 100

Это важно, потому что при открытии и закрытии используются разные стороны стакана (ask/bid), поэтому спреды различаются.

### Расчет спредов

1. **Спред на цену (pr_spread):**
   - Для открытия: (ask_long - bid_short) / bid_short * 100
   - Для закрытия: (bid_long - ask_short) / ask_short * 100

2. **Спред на фандинг (fr_spread):**
   - fr_long - fr_short (в процентах)
   - Показывает разницу в ставках фандинга между биржами

3. **Общий спред (total_spread):**
   - pr_spread + fr_spread
   - Учитывает как разницу в ценах, так и разницу в фандингах

### Настройки бота

- **Алерт спред min (%)**: Порог для закрытия позиции (например, -1%)
  - Когда спред закрытия достигает этого значения, приходит оповещение
- **Алерт спред max (%)**: Порог для открытия позиции (например, 9.5%)
  - Когда спред открытия достигает этого значения, приходит оповещение

### Работа бота

1. Бот каждую секунду запрашивает данные с бирж (цены ask/bid и фандинги)
2. Рассчитывает спреды открытия и закрытия
3. Выводит информацию в соответствующих окнах мониторинга
4. При достижении заданных порогов отправляет оповещения

### Пример работы

**Открытие позиции:**
- Найдена ситуация: GLM Long на MEXC, Short на Bybit
- Спред открытия достиг 9.5% → оповещение
- Открываем Long на MEXC (покупаем по ask) и Short на Bybit (продаем по bid) одновременно

**Закрытие позиции:**
- Мониторим спред закрытия
- Когда спред закрытия достигает -1% → оповещение
- Закрываем Long на MEXC (продаем по bid) и Short на Bybit (покупаем по ask) одновременно

## Проверка делистинга

### Назначение
Бот автоматически проверяет наличие новостей о делистинге монеты на биржах, участвующих в арбитраже. Это критически важно, так как торговля делистированной монетой невозможна.

### Когда выполняется проверка
Проверка делистинга выполняется автоматически после получения базовой информации о монете (цены и фандинги), но до начала мониторинга спредов.

### Поддерживаемые биржи
- **Bybit** - через официальный API announcements
- **Gate.io** - через HTML-скрапинг страниц объявлений
- **MEXC** - через HTML-скрапинг страниц объявлений
- **LBank** - поддержка может быть ограничена (зависит от доступности публичного API)

### Период поиска
По умолчанию проверяются объявления за последние **60 дней**. Это позволяет найти недавние делистинги, которые могли быть объявлены месяц назад.

### Как работает проверка

#### 1. Определение бирж для проверки
Бот проверяет делистинг только на тех биржах, которые участвуют в конкретном арбитраже.

**Пример:**
- Запрос: `"OBOL Long (bybit), Short (gate)"`
- Проверка делистинга выполняется только на **Bybit** и **Gate.io**

#### 2. Получение объявлений с бирж

**Bybit:**
- Используется официальный API: `GET /v5/announcements/index`
- Фильтры запроса:
  - `type=delistings` - только делистинги
  - `tag=Derivatives` - только деривативы (фьючерсы)
  - `locale=en-US`
  - `limit=50` на страницу
- Данные получаются с пагинацией (до 50 страниц)
- Используется UTC для корректного сравнения дат
- Буфер 6 часов для предотвращения потери событий на границе периода

**Gate.io и MEXC:**
- Используется HTML-скрапинг страниц объявлений
- Парсятся заголовки и тексты объявлений
- Извлекаются ссылки на полные объявления

#### 3. Поиск делистинга по монете

**Регулярное выражение для поиска монеты:**
- Ищет монету как отдельное слово: `OBOL`
- Ищет монету с суффиксом USDT: `OBOLUSDT`
- Учитывает, что фьючерсы торгуются только к USDT
- Пример регулярки: `(?<![A-Z0-9])OBOL(?:USDT)?(?![A-Z0-9])`

**Ключевые слова делистинга:**
- Английские: "delist", "delisting", "removal", "removed", "discontinued", "terminated", "trading suspended", "trading halt", "will be delisted", "to be delisted", "delisting announcement", "removal from trading", "cease trading"
- Русские: "удаление", "делистинг", "прекращение торговли", "удаление с биржи", "прекращение листинга", "исключение из торговли"

**Условия для определения делистинга:**
1. Монета упомянута в заголовке или тексте объявления (как `OBOL` или `OBOLUSDT`)
2. В тексте присутствуют ключевые слова делистинга
3. Или в тегах объявления есть `SYMBOL_DELISTING`

#### 4. Обработка результатов

**Если делистинг найден:**
- Выводится предупреждение в лог: `⚠️ Найден делистинг {coin}: {title}... | URL: {url}`
- Показывается URL объявления для проверки деталей
- Бот продолжает работу, но пользователь предупрежден о риске

**Если делистинг не найден:**
- Выводится подтверждение: `✓ Новостей о делистинге {coin} за последние {days_back} дней не найдено`
- Бот продолжает нормальную работу

### Технические детали

**Обработка дат:**
- Все даты обрабатываются в UTC для корректного сравнения
- Используется `datetime.now(timezone.utc)` для текущего времени
- Даты публикации парсятся с указанием timezone: `datetime.fromtimestamp(ms/1000, tz=timezone.utc)`
- Буфер 6 часов предотвращает потерю событий на границе периода (например, если делистинг был ровно 60 дней назад)

**Дедупликация:**
- Объявления дедуплицируются по URL (убираются query-параметры типа `utm_*`)
- Сохраняется порядок по дате публикации (новые → старые)

**Оптимизация:**
- Для Bybit используется ранняя остановка пагинации, если найдены объявления старше периода поиска
- Проверка выполняется только на биржах из запроса, что ускоряет работу

### Пример работы

**Запрос:** `"OBOL Long (bybit), Short (gate)"`

**Процесс:**
1. Получение данных о ценах и фандингах с Bybit и Gate.io
2. Автоматическая проверка делистинга OBOL на Bybit и Gate.io за последние 60 дней
3. Если найден делистинг:
   ```
   ⚠️ Найден делистинг OBOL: Delisting of OBOLUSDT Perpetual Contract... | URL: https://announcements.bybit.com/...
   ```
4. Если делистинг не найден:
   ```
   ✓ Новостей о делистинге OBOL за последние 60 дней не найдено
   ```

### Проверка доступности монеты

**Важно:** Если тикер не найден на бирже (API возвращает пустой результат), монета автоматически помечается как недоступная/делистированная:

- Выводится предупреждение: `⚠️ {coin} недоступна/делистирована на {exchange}`
- Выводится сообщение: `Арбитраж невозможен: тикер не найден на бирже Long/Short`
- Дальнейшая обработка арбитража прекращается
- Проверка делистинга не выполняется (так как монета уже недоступна)

## Проверка ликвидности

### Назначение
Бот автоматически проверяет ликвидность на биржах перед открытием позиций. Это критически важно для оценки возможности выполнения сделок без значительного проскальзывания (slippage) и потери прибыли.

### Когда выполняется проверка
Проверка ликвидности выполняется автоматически после расчета спредов и перед проверкой делистинга. Проверяется ликвидность на обеих биржах (Long и Short) для размеров сделок 50, 100, 150 USDT.

### Поддерживаемые биржи
- **Bybit** - через официальный API orderbook (`/v5/market/orderbook`)
- Другие биржи: поддержка может быть добавлена в будущем

### Размеры сделок
Проверка выполняется для трех размеров:
- **50 USDT** - минимальный размер
- **100 USDT** - средний размер
- **150 USDT** - максимальный размер

Эти размеры соответствуют типичным инвестициям на каждый ордер (Long и Short).

### Проверяемые параметры

#### 1. Top-of-book спред (Spread)
**Что проверяется:** Разница между лучшей ценой покупки (ask1) и лучшей ценой продажи (bid1) на первом уровне стакана.

**Формула:**
```
spread_bps = (ask1 - bid1) / mid * 10_000
```
где `mid = (bid1 + ask1) / 2.0`

**Порог:** ≤ 30 bps (0.30%)
- Если спред больше 30 bps, ликвидность считается недостаточной
- Большой спред означает высокую стоимость входа/выхода

#### 2. Глубина до размера сделки (Price Impact / Slippage)
**Что проверяется:** Эффективный проскальзывание при выполнении сделки заданного размера (VWAP - Volume Weighted Average Price).

**Метод расчета:**
1. Берется книга заявок (orderbook) с 50 уровнями
2. Рассчитывается VWAP для покупки (используя asks) и продажи (используя bids)
3. Вычисляется отклонение VWAP от средней цены (mid)

**Формула для buy impact:**
```
buy_impact_bps = |buy_vwap - mid| / mid * 10_000
```

**Формула для sell impact:**
```
sell_impact_bps = |mid - sell_vwap| / mid * 10_000
```

**Порог:** ≤ 50 bps (0.50%) на сторону
- Рекомендуется ≤ 30 bps для лучшей ликвидности
- 50 bps - компромиссный вариант для реальных рынков
- Если проскальзывание больше порога, ликвидность недостаточна для размера сделки

#### 3. Достаточность объема (Depth)
**Что проверяется:** Хватает ли объема в стакане для выполнения сделки заданного размера.

**Метод:**
- Проверяется, можно ли купить/продать нужный номинал (50/100/150 USDT) в пределах 50 уровней стакана
- Если объема не хватает, VWAP не может быть рассчитан (возвращается `None`)

**Порог:** Должно хватать объема для полного номинала сделки

### Пороговые значения

**Рекомендуемые пороги для размеров 50-150 USDT:**
- **max_spread_bps**: 30 (0.30%)
- **max_impact_bps**: 50 (0.50%) - компромиссный вариант
  - Лучше: 30 bps (0.30%) для более строгой проверки
- **orderbook_limit**: 50 уровней
  - Если часто "не хватает глубины", можно увеличить до 200 уровней

### Как работает проверка

#### 1. Получение orderbook
- Запрашивается книга заявок через API: `GET /v5/market/orderbook?category=linear&symbol=GPSUSDT&limit=50`
- Получаются списки bids (заявки на покупку) и asks (заявки на продажу)

#### 2. Расчет метрик
- **Спред:** `(ask1 - bid1) / mid * 10_000`
- **Buy VWAP:** Рассчитывается для покупки заданного номинала по asks
- **Sell VWAP:** Рассчитывается для продажи заданного номинала по bids
- **Buy Impact:** `|buy_vwap - mid| / mid * 10_000`
- **Sell Impact:** `|mid - sell_vwap| / mid * 10_000`

#### 3. Проверка условий
Проверка считается успешной (`ok = True`), если:
- Спред ≤ 30 bps
- Глубины хватает для полного номинала (buy_vwap и sell_vwap не None)
- Buy impact ≤ 50 bps
- Sell impact ≤ 50 bps

Если хотя бы одно условие не выполнено, проверка считается неуспешной (`ok = False`).

### Вывод результатов

**Успешная проверка:**
```
✓ Ликвидность bybit Long (GPS): 50 USDT | spread=15.2bps, buy_impact=12.5bps
✓ Ликвидность bybit Long (GPS): 100 USDT | spread=15.2bps, buy_impact=18.3bps
✓ Ликвидность bybit Long (GPS): 150 USDT | spread=15.2bps, buy_impact=25.1bps
```

**Неуспешная проверка:**
```
✗ Ликвидность bybit Long (GPS): 150 USDT | spread=45.3bps, buy_impact=65.2bps
  Причины: spread 45.3 bps > 30.0, buy impact 65.2 bps > 50.0
```

### Почему это важно

**24h volume не гарантирует ликвидность:**
- Большой дневной объем не означает, что прямо сейчас на top-of-book есть достаточная глубина
- VWAP/impact по orderbook - самый прямой тест "хватит ли ликвидности для входа/выхода без убийства PnL"

**Преимущества проверки:**
- Показывает реальную стоимость входа/выхода (проскальзывание)
- Предотвращает открытие позиций на рынках с низкой ликвидностью
- Помогает выбрать оптимальный размер сделки (50, 100 или 150 USDT)

### Технические детали

**API эндпоинт Bybit:**
- `GET /v5/market/orderbook`
- Параметры: `category=linear`, `symbol=COINUSDT`, `limit=50`
- Возвращает: `{"retCode": 0, "result": {"b": [[price, size], ...], "a": [[price, size], ...]}}`

**Расчет VWAP:**
- Итерация по уровням стакана (asks для покупки, bids для продажи)
- Накопление объема до достижения целевого номинала (USDT)
- Расчет средневзвешенной цены: `vwap = total_cost / total_base_quantity`

**Обработка недостаточной глубины:**
- Если объема не хватает, `vwap = None`
- В лог выводится информация о том, сколько USDT удалось "заполнить" (`buy_filled`, `sell_filled`)

### Пример работы

**Запрос:** `"GPS Long (bybit), Short (xt)"`

**Процесс:**
1. Получение данных о ценах и фандингах с Bybit и XT
2. Расчет спредов
3. Автоматическая проверка ликвидности на Bybit (Long) для размеров 50, 100, 150 USDT
4. Вывод результатов:
   ```
   ✓ Ликвидность bybit Long (GPS): 50 USDT | spread=12.5bps, buy_impact=8.3bps
   ✓ Ликвидность bybit Long (GPS): 100 USDT | spread=12.5bps, buy_impact=15.7bps
   ✓ Ликвидность bybit Long (GPS): 150 USDT | spread=12.5bps, buy_impact=22.1bps
   ```
5. Если ликвидность недостаточна:
   ```
   ✗ Ликвидность bybit Long (GPS): 150 USDT | spread=45.2bps, buy_impact=68.5bps
     Причины: spread 45.2 bps > 30.0, buy impact 68.5 bps > 50.0
   ```

