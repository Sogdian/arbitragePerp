# Контекст: Бот для скальпинга на отрицательном фандинге (fun.py)

## Основная идея

Торговля ведется на **одной бирже** в момент начисления **отрицательного фандинга**. 

**Гипотеза:** Сразу после выплаты фандинга цена фьючерса падает на величину этого фандинга (эту точку называем «справедливая цена»).

## Алгоритм действий бота

### 1. Подготовка (до времени выплаты)

- **Проверка ликвидности и новостей:** Используются существующие модули проверки ликвидности и мониторинга новостей/делистинга
- **Pre-flight проверки:** Проверка баланса, минимальных/максимальных размеров, шагов цены и количества, ликвидности на нужных уровнях стакана (сразу на всех 15 уровнях для Long)
- **Интерактивное подтверждение:** После успешных проверок бот выводит вопрос: **"Открывать позиции лонг и шорт?"**
  - Если пользователь отвечает **"Да"** → скрипт ждет назначенного времени и выполняет сделку
  - Если пользователь отвечает **"Нет"** или что-то другое → скрипт ничего не делает и завершается
- **Ожидание времени выплаты:** Бот готовится к работе к заданному времени (например, к 12:00)
- **Проверка времени:** Если скрипт запущен после времени выплаты → завершать с ошибкой

### 2. Фиксация цены

- **Момент фиксации:** Ровно в **11:59:59** (за 1 секунду до выплаты фандинга)
- **Тип цены:** Последняя цена сделки (last price) из тикера
- **Запоминание:** Цена сохраняется для дальнейших расчетов

### 3. Расчет уровней

- **Справедливая цена:** `Цена закрытия × (1 + фандинг%)`
  - Пример: цена 100 USDT, фандинг -2% → `100 × 0.98 = 98 USDT`
  
- **Цена лонг-ордера:** `Цена закрытия × (1 + фандинг% + отступ%)`
  - Пример: цена 100 USDT, фандинг -2%, отступ -0.3% → `100 × (1 - 0.02 - 0.003) = 100 × 0.977 = 97.7 USDT`
  - Формула: `Цена закрытия × (1 + фандинг% + отступ%)` где оба процента отрицательные

### 4. Открытие позиций (в 12:00:00, после начисления фандинга)

**Проверка перед открытием:**
- В момент открытия (12:00:00) проверяем **Last price** из тикера
- Если Last price уже ниже уровня Long ордера → **не открывать** ни Short, ни Long

**Параллельные запросы (одновременно):**

1. **Short лимитный:**
   - Тип: **Лимитный ордер** по лучшей цене **bid** из стакана (для Short = продажа по bid)
   - Условие: **Полное исполнение или отмена** (FOK)
   - Если не исполнился → Long не открывать
   - Если исполнился частично (не должно быть при FOK, но на всякий случай) → открывать Long на частичный объем

2. **Long лимитный:**
   - Тип: **Лимитный ордер** на уровне рассчитанной «цены лонг-ордера»
   - Условие: **Допускается частичное исполнение** (не FOK, можно закрывать частями)
   - Если не исполнился сразу → пробовать до **15 уровней** стакана, идя вниз по глубине
   - Если Short не открылся → Long не открывать

**Параметры ордеров:**
- Маржа: **Изолированная** (isolated)
- Плечо: **1x**

### 5. Завершение

- **Условие закрытия:** После того как оба ордера выставились (исполнились), нужно их закрыть **одновременно** сразу после подтверждения исполнения Long ордера
- **Механизм:** 
  - После выставления ордеров Short и Long → проверить, что ордера действительно открыли позиции (а не просто созданы)
  - Проверять статус Long ордера **максимально часто** - без задержки в цикле (с учетом rate limits API)
  - Как только Long ордер исполнился → **сразу** закрыть обе позиции одновременно (Short и Long)
  - Если при закрытии одна позиция закрылась, а вторая нет → продолжать попытки закрыть вторую позицию
  - После успешного закрытия обеих позиций → скрипт **завершается**

**Важно:**
- Если Short исполнился, а Long не исполнился после всех 15 попыток → **закрывать Short автоматически**
- Если Long не исполнился (и Short тоже не исполнился) → ничего не делать (пользователь будет закрывать вручную)
- Если цена ушла в другую сторону и Long не исполнился → ничего не делать (пользователь будет действовать вручную)

## Формат запуска бота

### Команда

```bash
python fun.py "STO Bybit 30 -2% 12:00 -0.3%"
```

### Параметры команды

1. **STO** — название торговой пары (монеты)
2. **Bybit** — биржа, на которой ведется торговля
3. **30** — количество монет в сделке для обоих ордеров
4. **-2%** — ставка фандинга, на которую должна скорректироваться цена (отрицательное значение)
5. **12:00** — время выплаты фандинга (используется **локальное время пользователя**, формат **HH:MM**)
6. **-0.3%** — дополнительный отступ вниз от справедливой цены для открытия лонга (отрицательное значение)

### Валидация формата

- Поддерживается **только указанный формат** команды
- **Регистр:** Не важен (например, "STO" = "sto" = "Sto")
- **Пробелы:** Строго один пробел между параметрами
- **Формат процентов:** Только с знаком `%` (например, `-2%`, `-0.3%`)
- **Знак процентов:** Только отрицательные значения (например, `-2%`, `-0.3%`)
- **Проверка биржи:** Достаточно проверить наличие биржи в списке поддерживаемых
- **Проверка времени:** Если текущее время уже позже времени выплаты → ошибка
- Валидация других параметров (например, проверка отрицательности фандинга) **не требуется**

## Практический пример

### Условия:
- Монета: **STO**
- Биржа: **Bybit**
- Количество: **30 монет**
- Фандинг: **-2%**
- Время выплаты: **12:00** (локальное время)
- Отступ: **-0.3%**

### Сценарий:

1. **11:59:59** — Фиксация цены: **100 USDT** (last price)

2. **Расчет уровней:**
   - Справедливая цена: `100 × 0.98 = 98 USDT`
   - Цена лонг-ордера: `100 × (1 - 0.02 - 0.003) = 100 × 0.977 = 97.7 USDT`

3. **12:00:00** — Открытие позиций (параллельно):
   - **Short:** Лимитный ордер на продажу 30 STO по лучшей цене **bid** из стакана (≈100 USDT)
   - **Long:** Лимитный ордер на покупку 30 STO по цене **97.7 USDT**

4. **После исполнения:**
   - Проверяем статус Long ордера максимально часто
   - Как только Long ордер исполнился → **сразу** закрываем обе позиции одновременно
   - После успешного закрытия → скрипт завершается

## Технические детали

### Время

- **Часовой пояс:** Локальное время пользователя (не UTC)
- **Точность:** Фиксация цены в 11:59:59, открытие ордеров в 12:00:00 (но после начисления фандинга)
- **Формат времени:** Только **HH:MM** (например, "12:00", "16:00", "00:00")
- **Режим работы:** Скрипт работает только на **1 сделку** на конкретное время выплаты фандинга
- **Прерывание скрипта:** Если пользователь прервал скрипт (Ctrl+C) во время ожидания времени выплаты → просто завершить (без отмены ордеров, если они были выставлены)

### Обработка ошибок

1. **Short не открылся:**
   - Long не открывать
   - Записать лог об ошибке

2. **Long не открылся сразу:**
   - Пробовать до **15 уровней** стакана, идя вниз по глубине
   - Записывать лог о каждой попытке
   - Если не исполнился после всех попыток:
     - Если Short исполнился → **закрывать Short автоматически**
     - Если Short тоже не исполнился → ничего не делать (пользователь закроет вручную)

3. **Short исполнился частично:**
   - Не должно быть (FOK = только полностью или отмена)
   - Но если произошло → открывать Long на частичный объем Short

4. **Цена уже ниже уровня Long в момент открытия (12:00:00):**
   - Проверка по **Last price** из тикера
   - Если Last price ниже уровня Long → не открывать ни Short, ни Long
   - Записать лог об этом

5. **Цена ушла в другую сторону:**
   - Ничего не делать (пользователь будет действовать вручную)

6. **Скрипт запущен после времени выплаты:**
   - Если текущее время уже позже указанного времени выплаты → завершать с ошибкой
   - Записать лог об ошибке

### Интеграция с существующим кодом

1. **position_opener.py:**
   - **Переиспользовать код** для открытия позиций
   - Использовать функции планирования и размещения ордеров
   - Адаптировать под требования FOK (для Short) и частичного исполнения (для Long)
   - **Переиспользовать `close_long_short_positions`** для закрытия позиций (адаптировать под одну биржу)

2. **Модули проверки:**
   - **Проверка ликвидности:** Использовать существующую логику из `scan_spreads.py`
   - **Мониторинг новостей/делистинга:** Использовать `news_monitor.py` и `announcements_monitor.py`
   - **Последовательность:** Сначала проверки → если все ОК → пользователь дает команду "Да" → ожидание времени → исполнение

### Логирование

- **Уровень детализации:** Средний
- **Что логировать:**
  - Результаты проверок ликвидности и новостей (как в примере из терминала)
  - Время фиксации цены и саму цену
  - Расчет справедливой цены и цены лонг-ордера
  - Проверка Last price перед открытием (12:00:00)
  - Попытки открытия Short и Long
  - Результаты исполнения ордеров
  - Проверка что ордера открыли позиции (после выставления)
  - Попытки Long по уровням стакана (до 15)
  - Статус проверки Long ордера (максимально часто, без задержки)
  - Автоматическое закрытие Short (если Long не исполнился)
  - Момент закрытия позиций
  - Попытки закрыть вторую позицию (если первая закрылась)
  - Ошибки и предупреждения
- **Telegram уведомления:** Не нужны

### Мониторинг

- **Мониторинг позиций после открытия:** Не нужен
- **Stop-loss/Take-profit:** Пока не требуется (будет добавлено позже)

### Размер позиции

- **Минимальный/максимальный размер:** Определяется из параметра команды (количество монет)
- **Проверка:** Выполняется на этапе pre-flight проверок

## Структура скрипта

### Основные компоненты

1. **Парсер команды:** Разбор формата `"STO Bybit 30 -2% 12:00 -0.3%"`
2. **Проверки:** Ликвидность, новости, делистинг, баланс, параметры
3. **Интерактивное подтверждение:** Вопрос "Открывать позиции лонг и шорт?"
4. **Ожидание времени:** Точная синхронизация с локальным временем (с обработкой Ctrl+C)
5. **Фиксация цены:** Получение last price в 11:59:59
6. **Расчет уровней:** Справедливая цена и цена лонг-ордера
7. **Проверка перед открытием:** Проверка Last price в 12:00:00 (не ниже уровня Long)
8. **Открытие позиций:** Параллельное открытие Short и Long в 12:00:00 (одновременные запросы)
9. **Проверка открытия позиций:** Убедиться, что ордера действительно открыли позиции (после выставления)
10. **Мониторинг исполнения:** Отслеживание статуса Long ордера максимально часто (без задержки, с учетом rate limits)
11. **Закрытие позиций:** Автоматическое закрытие обеих позиций сразу после подтверждения исполнения Long
12. **Обработка частичного закрытия:** Продолжение попыток закрыть вторую позицию, если первая закрылась
13. **Автоматическое закрытие Short:** Если Long не исполнился после всех попыток, а Short исполнился
14. **Завершение:** Скрипт завершается после успешного закрытия позиций

### Зависимости

- Использование существующих модулей бирж (`exchanges/`)
- Переиспользование `position_opener.py` для открытия позиций
- Интеграция с модулями проверки ликвидности и новостей

## Примеры использования

### Пример 1: Базовая сделка

```bash
python fun.py "STO Bybit 30 -2% 12:00 -0.3%"
```

### Пример 2: Другая монета и время

```bash
python fun.py "BTC Binance 0.1 -1.5% 16:00 -0.5%"
```

### Пример 3: Gate.io

```bash
python fun.py "ETH Gate 10 -3% 00:00 -0.2%"
```

## Важные замечания

1. **Однократное исполнение:** Скрипт работает только на одну сделку в указанное время
2. **Локальное время:** Все временные метки используют локальное время пользователя
3. **Тип ордеров:** 
   - **Short:** FOK (только полное исполнение или отмена)
   - **Long:** Допускается частичное исполнение (можно закрывать частями)
4. **Ручное управление:** Если что-то пошло не так, пользователь будет действовать вручную
5. **Интеграция:** Максимальное переиспользование существующего кода для надежности
