# CONTEXT: Фандинг-арбитраж между биржами (scan_fundings_spreads.py)

## Обзор

Модуль **`scan_fundings_spreads.py`** — бот для поиска пар бирж и монет по стратегии фандинг-арбитража между двумя биржами. Он только **мониторит** возможности и шлёт уведомления в консоль и Telegram; открытие и закрытие ордеров планируется реализовать отдельно.

---

## 1. Стратегия фандинг-арбитража

### Общая концепция

- **Биржа 1 (Long):** фандинг сильно отрицательный (например −2%). В лонге мы **получаем** фандинг от шортистов.
- **Биржа 2 (Short):** фандинг от 0 до ~0.5% — хедж; в шорте мы **платим** не больше ~0.5%.
- За некоторое время до выплаты фандинга на бирже 1 входим в **Long** на бирже 1 и в **Short** на бирже 2.
- В момент выплаты на бирже 1 получаем фандинг (например −2%), на бирже 2 платим от 0 до 0.5%.
- После выплаты закрываем обе позиции.

### Детали стратегии

1. **Мониторинг фандингов** — постоянно проверяются актуальные ставки на двух биржах. Если фандинги меняются и сделка перестаёт быть прибыльной, бот предупреждает, чтобы не входить.
2. **Спред цен** — мониторинг следит, чтобы спред цен между биржами был минимальным. Вход и выход — в моменты минимального спреда; сделки лимитными ордерами.
3. **Формула спреда фандинга (наша выгода):**  
   получаем на Long (`-funding_long`) − платим на Short (`funding_short`) в процентах.  
   Пример: Long −2%, Short +0.5% → спред фандинга = 2% − 0.5% = **1.5%**.

---

## 2. Бот scan_fundings_spreads.py

### Назначение

- Находить пары **(биржа Long, биржа Short)** и монеты, где:
  - спред фандинга ≥ **MIN_FUNDING_SPREAD** (например 1.5% или 2%);
  - спред цен между биржами ≤ **MAX_PRICE_SPREAD** (минимальное проскальзывание при входе/выходе).
- Проводить анализ ликвидности и новостей (делистинг, безопасность) и выводить вердикт: ✅ арбитражить / ❌ не арбитражить.
- Писать одну строку в **консоль** на каждую подходящую пару (без записи в файл).
- Отправлять в **Telegram** одно сообщение на монету (картинка-таблица + подпись), только если до выплаты фандинга на Long-бирже осталось меньше **SCAN_FUNDING_MIN_TIME_TO_PAY** минут.

### Условия отбора пар

Для каждой монеты перебираются пары бирж `(ex1, ex2)`:

- **Long на ex1, Short на ex2:**
  - `spread_funding = (-funding_long - funding_short) * 100` (в %).  
    Условие: `spread_funding >= MIN_FUNDING_SPREAD`.
  - `spread_price = (bid_short - ask_long) / ask_long * 100` (спред входа в %).  
    Условие: `spread_price <= MAX_PRICE_SPREAD`.

- Аналогично проверяется пара **Long на ex2, Short на ex1**.

Только пары, прошедшие оба порога, попадают в анализ ликвидности и новостей и в лог.

### Формулы

| Величина | Формула |
|----------|---------|
| Спред фандинга (%), наша выгода | `(-funding_long - funding_short) * 100` |
| Спред по цене (%) | `(bid_short - ask_long) / ask_long * 100` |
| Общий спред (%) | `spread_price + spread_funding` |

Пример: Long −2%, Short +0.5% → спред фандинга 1.5%. Спред по цене 0.8% → общий спред 2.3%.

### Поток данных

1. **Сбор монет:** `collect_coins_by_exchange` — список фьючерсных монет по каждой бирже (union, без EXCLUDE_COINS и цифровых префиксов).
2. **Fetch по монете:** для каждой биржи, где есть монета, запрашиваются:
   - тикер (`get_futures_ticker`) — bid, ask, price;
   - фандинг (`get_funding_info` при наличии, иначе `get_funding_rate`) — `funding_rate`, `next_funding_time` (для расчёта минут до выплаты).
3. **Фильтр пар:** для всех пар бирж считаются спред фандинга и спред по цене; остаются только пары с `spread_funding >= MIN_FUNDING_SPREAD` и `spread_price <= MAX_PRICE_SPREAD`.
4. **Анализ:** для каждой такой пары вызывается `_analyze_and_log_opportunity`:
   - ликвидность: `check_liquidity(coin, notional_usdt=SCAN_COIN_INVEST, ob_limit=50, max_spread_bps=30, max_impact_bps=50)` для Long и Short;
   - новости: кеш по `(coin, exchange)`, TTL **NEWS_CACHE_TTL_SEC**; делистинг и безопасность по обеим биржам.
5. **Лог:** одна строка в консоль на пару в формате:
   - `{COIN} Long (ex1), Short (ex2) Спред на цену: X.XXX% | Фандинг: Y.YYY% | Спред общий: Z.ZZZ% ✅/❌ (причины или кол-во монет)`.
6. **Telegram:** среди возможностей с вердиктом ✅ отбираются те, у которых `minutes_until` (до выплаты на Long-бирже) **< SCAN_FUNDING_MIN_TIME_TO_PAY**. По каждой монете — одно сообщение: картинка-таблица + подпись (на русском); при отсутствии PIL — текст `_format_combined_telegram_message`.

### Переменные окружения (.env)

| Переменная | Смысл | Пример |
|------------|--------|--------|
| **MIN_FUNDING_SPREAD** | Минимальный спред фандинга (%), чтобы считать возможность интересной | 1.5, 2 |
| **MAX_PRICE_SPREAD** | Максимальный допустимый спред цен (%) между биржами | 1.5, 2 |
| **SCAN_FUNDING_MIN_TIME_TO_PAY** | Порог минут до выплаты: в Telegram шлём только если до выплаты < этого значения | 60 |
| **SCAN_FUNDING_INTERVAL_SEC** | Интервал сканирования (сек) | 60 |
| **SCAN_FUNDING_MAX_CONCURRENCY** | Параллелизм HTTP-запросов | 20 |
| **SCAN_FUNDING_COIN_BATCH_SIZE** | Размер батча монет за проход | 50 |
| **SCAN_FUNDING_REQ_TIMEOUT_SEC** | Таймаут запросов (сек) | 20 |
| **SCAN_FUNDING_MEXC_REQ_TIMEOUT_SEC** | Таймаут для MEXC (сек) | 45 |
| **SCAN_COIN_INVEST** | Объём в USDT для проверки ликвидности и расчёта кол-ва монет | 50 |
| **NEWS_CACHE_TTL_SEC** | TTL кеша новостей (сек) | 180 |
| **SCAN_ANALYSIS_MAX_CONCURRENCY** | Параллелизм анализа (ликвидность + новости) | 2 |
| **EXCLUDE_COINS** | Монеты через запятую для исключения | FLOW,BTC |
| **EXCLUDE_EXCHANGES** | В коде зашито `{"lbank"}` | — |

Используются также **config** (TEST_CHANNEL_ID, BOT_TOKEN, ENABLE_TELEGRAM и т.д.) и общий **PerpArbitrageBot** (биржи, news_monitor, announcements_monitor, x_news_monitor).

### Логирование

- Только консоль (StreamHandler), **без записи в файл**.
- Имя логгера: `scan_fundings_spreads`.
- Подробные логи от httpx, bot, news_monitor, exchanges и т.д. заглушены (WARNING/CRITICAL).

### Зависимости

- **bot.PerpArbitrageBot** — биржи, новости.
- **telegram_sender.TelegramSender** — отправка в канал (TEST_CHANNEL_ID).
- **config** — ENV_MODE, TEST_CHANNEL_ID и др.
- Биржи с методом **get_funding_info** (funding_rate + next_funding_time); при его отсутствии используется **get_funding_rate** (тогда `minutes_until` будет None и в Telegram по этой паре не попадёт).

### Запуск

```bash
python3 scan_fundings_spreads.py
```

Цикл: обновление списка монет → `scan_once` по батчам → пауза **SCAN_FUNDING_INTERVAL_SEC** секунд.

---

## 3. Что не реализовано (планируется)

- **Открытие позиций:** за N минут до выплаты фандинга на бирже Long — лимитные ордера Long на бирже 1 и Short на бирже 2.
- **Закрытие позиций:** после выплаты фандинга — закрытие обеих позиций в момент минимального спреда цен, лимитными ордерами.

Весь контекст по новому боту и стратегии описан выше; при добавлении открытия/закрытия ордеров этот раздел можно расширить.
